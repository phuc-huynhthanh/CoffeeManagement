<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="/assets/coffee.png" type="image/png" />
    <title>Brother's Hai Coffee</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Toast Container */
      #toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      /* Toast Base */
      .toast {
        min-width: 300px;
        max-width: 400px;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        animation: slideIn 0.3s ease-out;
        transition: all 0.3s ease;
      }

      .toast:hover {
        transform: translateX(-5px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
      }

      /* Toast Types */
      .toast-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
      }

      .toast-error {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
      }

      .toast-warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
      }

      .toast-info {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
      }

      /* Toast Icon */
      .toast-icon {
        font-size: 24px;
        flex-shrink: 0;
      }

      /* Toast Content */
      .toast-content {
        flex: 1;
        font-size: 14px;
        line-height: 1.5;
        font-weight: 500;
      }

      /* Toast Close Button */
      .toast-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        transition: background 0.2s;
        flex-shrink: 0;
      }

      .toast-close:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      /* Animation */
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }

      .toast-exit {
        animation: slideOut 0.3s ease-in forwards;
      }

      /* Tab Styles */
      .tab-button {
        padding: 12px 24px;
        border: none;
        background: #f3f4f6;
        color: #6b7280;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        border-radius: 8px 8px 0 0;
      }

      .tab-button.active {
        background: #3b82f6;
        color: white;
      }

      .tab-button:hover:not(.active) {
        background: #e5e7eb;
        color: #374151;
      }

      /* Combo Badge */
      .combo-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      /* Badge B√°n ch·∫°y */
      .bestseller-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.4);
        animation: pulse-badge 2s infinite;
        z-index: 10;
      }

      @keyframes pulse-badge {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      /* ============================================
         RESPONSIVE DESIGN
         ============================================ */

      /* Tablet (768px - 1024px) */
      @media screen and (max-width: 1024px) {
        .main-container {
          flex-direction: column;
        }

        .product-section {
          width: 100%;
          max-width: 100%;
        }

        .bill-section {
          width: 100%;
          max-width: 100%;
          height: auto;
          max-height: 400px;
          position: relative;
        }

        .product-grid {
          grid-template-columns: repeat(3, 1fr);
        }

        .header-container {
          flex-direction: column;
          gap: 1rem;
          align-items: stretch;
        }

        .header-left,
        .header-right {
          justify-content: center;
          flex-wrap: wrap;
        }
      }

      /* Mobile Large (481px - 768px) */
      @media screen and (max-width: 768px) {
        .product-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 12px;
        }

        .product {
          padding: 12px;
        }

        .product img {
          width: 80px;
          height: 80px;
        }

        .product h3 {
          font-size: 14px;
        }

        .product p {
          font-size: 12px;
        }

        .tab-button {
          padding: 8px 16px;
          font-size: 14px;
        }

        .search-filter-container {
          flex-direction: column;
          gap: 8px;
        }

        .search-filter-container input,
        .search-filter-container select {
          width: 100%;
        }

        .bill-section {
          max-height: 350px;
        }

        .action-buttons {
          flex-direction: column;
          gap: 8px;
        }

        .action-buttons button {
          width: 100%;
        }

        .ban-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .header-container {
          padding: 12px;
        }

        #tenNhanVien {
          font-size: 14px;
        }
      }

      /* Mobile Small (320px - 480px) */
      @media screen and (max-width: 480px) {
        .product-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 8px;
        }

        .product {
          padding: 8px;
        }

        .product img {
          width: 60px;
          height: 60px;
        }

        .product h3 {
          font-size: 12px;
          line-height: 1.2;
        }

        .product p {
          font-size: 11px;
        }

        .bestseller-badge {
          font-size: 9px;
          padding: 2px 6px;
          top: 4px;
          right: 4px;
        }

        .combo-badge {
          font-size: 9px;
          padding: 2px 6px;
        }

        .tab-button {
          padding: 6px 12px;
          font-size: 12px;
        }

        .bill-item {
          padding: 8px;
          font-size: 13px;
        }

        .bill-item .flex {
          flex-direction: column;
          gap: 8px;
        }

        .total-section {
          padding: 12px;
        }

        .total-section span {
          font-size: 16px;
        }

        .size-modal > div {
          width: 95%;
          max-width: 350px;
          margin: 10px;
        }

        .size-modal h2 {
          font-size: 16px;
        }

        .payment-modal > div {
          width: 95%;
          padding: 16px;
        }

        .payment-modal .flex-col.md\:flex-row {
          flex-direction: column;
        }

        .ban-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 8px;
        }

        .ban-grid > div {
          padding: 8px;
          font-size: 12px;
        }

        .header-container {
          padding: 8px 12px;
        }

        #tenNhanVien {
          font-size: 12px;
        }

        #logoutBtn {
          padding: 6px 12px;
          font-size: 12px;
        }
      }

      /* Landscape mobile */
      @media screen and (max-width: 768px) and (orientation: landscape) {
        .main-container {
          flex-direction: row;
        }

        .product-section {
          width: 60%;
        }

        .bill-section {
          width: 40%;
          max-height: 100vh;
        }

        .product-grid {
          grid-template-columns: repeat(3, 1fr);
        }
      }

      /* Touch-friendly */
      @media (hover: none) and (pointer: coarse) {
        .product {
          min-height: 120px;
        }

        button {
          min-height: 44px;
          min-width: 44px;
        }

        input,
        select {
          min-height: 44px;
          font-size: 16px;
        }

        .tab-button {
          min-height: 44px;
        }
      }

      /* ·∫®n scrollbar nh∆∞ng v·∫´n scroll ƒë∆∞·ª£c */
      .hide-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      .hide-scrollbar::-webkit-scrollbar {
        display: none;
      }

      .mobile-only {
        display: none;
      }

      .desktop-only {
        display: block;
      }

      @media screen and (max-width: 768px) {
        .mobile-only {
          display: block;
        }

        .desktop-only {
          display: none;
        }
      }
    </style>
  </head>

  <body class="bg-gray-100 flex flex-col min-h-screen">
    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2"></div>

    <!-- Header -->
    <header
      class="header-container bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 md:px-8 py-3 md:py-4 flex flex-col md:flex-row justify-between items-center shadow-md fixed w-full z-[100] gap-3 md:gap-0"
    >
      <h1 class="text-xl md:text-2xl font-bold tracking-wide">‚òïBrother's Hai Coffee</h1>
      <div class="header-right flex flex-wrap gap-2 md:gap-3 items-center justify-center w-full md:w-auto">
        <input
          id="search"
          type="text"
          placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..."
          class="px-3 md:px-4 py-2 rounded-lg text-gray-800 w-full sm:w-40 md:w-64 focus:outline-none focus:ring-2 focus:ring-yellow-400 text-sm md:text-base"
        />
        <select id="filter" class="px-2 md:px-3 py-2 rounded-lg text-gray-800 text-sm md:text-base">
          <option value="">T·∫•t c·∫£ lo·∫°i</option>
          <% loai.forEach(l => { %>
          <option value="<%= l %>"><%= l %></option>
          <% }) %>
        </select>
        <div class="flex items-center gap-2 bg-white text-gray-800 px-2 md:px-3 py-1 rounded-full shadow-md">
          <p id="tenNhanVien" class="font-semibold text-xs md:text-sm max-w-[80px] md:max-w-[150px] truncate"></p>
          <button id="logoutBtn" class="ml-1 md:ml-2 text-red-500 hover:text-red-700 font-semibold text-xs md:text-sm">
            ƒêƒÉng xu·∫•t
          </button>
        </div>
      </div>
    </header>

    <!-- N·ªôi dung -->
    <div class="main-container flex flex-1 overflow-hidden">
      <div class="product-section flex-1 flex flex-col">
        <!-- Tab Navigation -->
        <div class="sticky top-[120px] md:top-20 z-20 bg-white flex border-b px-4 md:px-6 py-2 md:py-3 gap-2 md:gap-4 !w-full !fixed -mt-2">
          <button class="tab-button active px-3 md:px-4 py-2 rounded-t-xl font-semibold text-sm md:text-base text-gray-700 hover:bg-blue-100 transition" data-tab="products">
            üçµ S·∫£n Ph·∫©m
          </button>
          <button class="tab-button px-3 md:px-4 py-2 rounded-t-xl font-semibold text-sm md:text-base text-gray-700 hover:bg-blue-100 transition" data-tab="combos">
            üéÅ Combo
          </button>
        </div>

        <!-- Tab Content -->
        <div class="flex-1 overflow-hidden">
          <div id="products-tab" class="tab-content block h-full overflow-y-auto hide-scrollbar">
            <div
              id="product-list"
              class="product-grid mt-36 md:mt-32 grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 md:gap-6 p-3 md:p-6 w-full lg:w-3/4"
            >
              <% sanPham.forEach(p => { %>
              <div
                class="product bg-white rounded-xl md:rounded-2xl shadow hover:shadow-xl hover:scale-105 transform transition cursor-pointer flex flex-col items-center text-center p-2 md:p-4 relative"
                data-id="<%= p.san_pham_id %>"
                data-ten="<%= p.ten_san_pham %>"
                data-gia="<%= p.gia_co_ban %>"
                data-loai="<%= p.ten_loai %>"
              >
                <img
                  src="<%= p.hinh_anh %>"
                  alt="<%= p.ten_san_pham %>"
                  class="w-20 h-20 sm:w-24 sm:h-24 md:w-28 md:h-28 object-cover rounded-lg md:rounded-xl mb-2 md:mb-3"
                />
                <h3 class="text-sm md:text-lg font-semibold text-gray-800 line-clamp-2"><%= p.ten_san_pham %></h3>
                <p class="text-gray-500 text-xs md:text-sm mb-1"><%= p.ten_loai %></p>
                <p class="text-blue-600 font-bold text-sm md:text-base"><%= Number(p.gia_co_ban).toLocaleString() %> ƒë</p>
              </div>
              <% }) %>
            </div>
          </div>

          <div id="combos-tab" class="tab-content hidden h-full overflow-y-auto hide-scrollbar">
            <div
              id="combo-list"
              class="product-grid grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 md:gap-6 p-3 md:p-6 w-full lg:w-3/4 mt-36 md:mt-32"
            ></div>
          </div>
        </div>
      </div>

      <!-- H√≥a ƒë∆°n -->
      <aside
        id="billAside"
        class="bill-section w-full sm:w-80 md:w-96 bg-white shadow-xl border-l rounded-tl-2xl flex flex-col fixed top-[120px] md:top-[80px] right-0 h-[calc(100vh-120px)] md:h-[90vh] z-50"
      >
        <div class="p-3 md:p-4 bg-blue-600 text-white font-semibold text-base md:text-lg flex-shrink-0 rounded-tl-2xl">H√≥a ƒë∆°n</div>
        <div id="bill" class="flex-1 p-3 md:p-4 overflow-y-auto hide-scrollbar">
          <p id="empty" class="text-gray-400 text-center mt-6 md:mt-10 text-sm md:text-base">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o</p>
        </div>
        <div class="border-t p-3 md:p-4 bg-gray-50 flex flex-col gap-2 flex-shrink-0">
          <div class="flex justify-between mb-1 md:mb-2 text-base md:text-lg">
            <span>T·ªïng ti·ªÅn:</span>
            <span id="total" class="font-bold text-blue-600">0 ƒë</span>
          </div>
          <button id="chooseTableBtn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-2 md:py-3 rounded-xl font-semibold transition text-sm md:text-base">
            Ch·ªçn b√†n
          </button>
          <button id="completeBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 md:py-3 rounded-xl font-semibold transition hidden text-sm md:text-base">
            Ho√†n t·∫•t
          </button>
          <button id="viewTablesBtn" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 md:py-3 rounded-xl font-semibold transition text-sm md:text-base">
            Xem danh s√°ch b√†n
          </button>
        </div>
      </aside>
    </div>

    <!-- Modal danh s√°ch b√†n -->
    <div id="banContainer" class="hidden fixed inset-0 flex items-center justify-center z-[200] bg-black bg-opacity-40 p-4">
      <div class="bg-white rounded-2xl shadow-xl p-4 md:p-6 w-full max-w-5xl max-h-[85vh] overflow-y-auto">
        <h2 class="text-base md:text-lg font-semibold mb-3 md:mb-4 text-center">Ch·ªçn b√†n</h2>
        <div id="banList" class="ban-grid grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 md:gap-4"></div>
        <button id="closeBanBtn" class="mt-3 md:mt-4 w-full bg-gray-200 py-2 md:py-3 rounded-lg hover:bg-gray-300 text-sm md:text-base">ƒê√≥ng</button>
      </div>
    </div>

    <!-- Modal xem danh s√°ch b√†n + m√≥n -->
    <div id="viewBanContainer" class="hidden fixed inset-0 flex items-center justify-center z-[200] bg-black bg-opacity-40 p-4">
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-5xl h-[85vh] flex flex-col">
        <div class="p-4 md:p-6 border-b flex-shrink-0">
          <h2 class="text-base md:text-lg font-semibold text-center">Danh s√°ch b√†n</h2>
        </div>

        <div id="viewBanList" class="p-3 md:p-6 flex-1 overflow-y-auto hide-scrollbar">
          <div id="viewBanGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-4"></div>
        </div>

        <div class="p-3 md:p-4 border-t flex-shrink-0">
          <button onclick="closeViewBanModal()" class="w-full bg-gray-200 py-2 md:py-3 rounded-lg hover:bg-gray-300 font-semibold text-sm md:text-base">ƒê√≥ng</button>
        </div>
      </div>
    </div>

    <script>
      // ============================================
      // TOAST NOTIFICATION SYSTEM
      // ============================================
      const Toast = {
        container: null,
        init() {
          if (!this.container) this.container = document.getElementById("toast-container");
        },
        show(message, type = "info", duration = 3000) {
          this.init();
          const icons = { success: "‚úì", error: "‚úö", warning: "‚ö†", info: "‚Ñπ" };
          const toast = document.createElement("div");
          toast.className = `toast toast-${type}`;
          toast.innerHTML = `<div class="toast-icon">${icons[type]}</div><div class="toast-content">${message}</div><button class="toast-close">√ó</button>`;
          this.container.appendChild(toast);
          toast.querySelector(".toast-close").addEventListener("click", () => this.remove(toast));
          setTimeout(() => this.remove(toast), duration);
        },
        remove(toast) {
          toast.classList.add("toast-exit");
          setTimeout(() => toast.remove(), 300);
        },
        success(m, d) { this.show(m, "success", d); },
        error(m, d) { this.show(m, "error", d); },
        warning(m, d) { this.show(m, "warning", d); },
        info(m, d) { this.show(m, "info", d); },
      };

      // ============================================
      // BESTSELLER SYSTEM
      // ============================================
      let sanPhamBanChay = [];

      async function loadSanPhamBanChay() {
        try {
          const response = await fetch("/sanpham/ban-chay?min=10");
          const result = await response.json();

          if (result.success && result.data) {
            sanPhamBanChay = result.data;
            console.log("üî• S·∫£n ph·∫©m b√°n ch·∫°y:", sanPhamBanChay);
            updateBestsellerBadges();
          }
        } catch (error) {
          console.error("L·ªói khi t·∫£i s·∫£n ph·∫©m b√°n ch·∫°y:", error);
          sanPhamBanChay = [];
        }
      }

      function laSanPhamBanChay(sanPhamId) {
        return sanPhamBanChay.includes(Number(sanPhamId));
      }

      function updateBestsellerBadges() {
        document.querySelectorAll(".product").forEach((el) => {
          const sanPhamId = el.dataset.id;
          const oldBadge = el.querySelector(".bestseller-badge");
          if (oldBadge) oldBadge.remove();

          if (laSanPhamBanChay(sanPhamId)) {
            const badge = document.createElement("div");
            badge.className = "bestseller-badge";
            badge.innerHTML = "üî• B√°n ch·∫°y";
            el.appendChild(badge);
          }
        });
      }

      // ============================================
      // TAB SYSTEM
      // ============================================
      function initTabs() {
        const tabButtons = document.querySelectorAll(".tab-button");
        const tabContents = document.querySelectorAll(".tab-content");

        tabButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const tabId = button.dataset.tab;

            tabButtons.forEach((btn) => btn.classList.remove("active"));
            button.classList.add("active");

            tabContents.forEach((content) => {
              content.classList.remove("active");
              content.classList.add("hidden");
            });

            const activeContent = document.getElementById(`${tabId}-tab`);
            activeContent.classList.remove("hidden");
            activeContent.classList.add("active");
          });
        });
      }

      // ============================================
      // COMBO SYSTEM
      // ============================================
      let comboList = [];

      async function loadCombos() {
        try {
          const response = await fetch("http://localhost:3000/combo/laytatca");
          const data = await response.json();

          if (data.success && data.data) {
            comboList = data.data;
            renderCombos();
          } else {
            console.error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch combo");
          }
        } catch (error) {
          console.error("L·ªói khi t·∫£i combo:", error);
          Toast.error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch combo");
        }
      }

      function renderCombos() {
        const comboListEl = document.getElementById("combo-list");

        if (!comboList.length) {
          comboListEl.innerHTML = `
            <div class="col-span-full text-center py-8">
              <p class="text-gray-500">Kh√¥ng c√≥ combo n√†o</p>
            </div>
          `;
          return;
        }

        comboListEl.innerHTML = comboList
          .map(
            (combo) => `
          <div
            class="combo bg-white rounded-2xl shadow hover:shadow-xl hover:scale-105 transform transition cursor-pointer flex flex-col items-center text-center p-4 relative"
            data-id="${combo.combo_id}"
            data-ten="${combo.ten_combo}"
            data-gia="${combo.gia_combo}"
            data-mota="${combo.mo_ta}"
            data-sanpham='${JSON.stringify(combo.san_pham)}'
          >
            <div class="combo-badge">COMBO</div>
            <img
              src="${combo.hinh_anh || "/assets/coffee.png"}"
              alt="${combo.ten_combo}"
              class="w-28 h-28 object-cover rounded-xl mb-3"
            />
            <h3 class="text-lg font-semibold text-gray-800">
              ${combo.ten_combo}
            </h3>
            <p class="text-gray-500 text-sm mb-2 line-clamp-2" title="${combo.mo_ta}">
              ${combo.mo_ta}
            </p>
            <div class="flex items-center justify-center gap-2 mb-2">
              ${
                combo.gia_goc && combo.gia_goc !== "0"
                  ? `
                <p class="text-gray-400 text-sm line-through">
                  ${Number(combo.gia_goc).toLocaleString()} ƒë
                </p>
              `
                  : ""
              }
              <p class="text-red-600 font-bold">
                ${Number(combo.gia_combo).toLocaleString()} ƒë
              </p>
            </div>
            <div class="text-xs text-gray-600 bg-gray-100 rounded-lg px-2 py-1">
              ${combo.san_pham.length} s·∫£n ph·∫©m
            </div>
          </div>
        `
          )
          .join("");

        document.querySelectorAll(".combo").forEach((el) => {
          el.addEventListener("click", () => {
            const combo = {
              combo_id: +el.dataset.id,
              ten_combo: el.dataset.ten,
              gia_combo: +el.dataset.gia,
              mo_ta: el.dataset.mota,
              san_pham: JSON.parse(el.dataset.sanpham),
              is_combo: true,
            };
            addComboToBill(combo);
          });
        });
      }

      function addComboToBill(combo) {
        const existingCombo = bill.find((item) => item.combo_id === combo.combo_id && item.is_combo);

        if (existingCombo) {
          existingCombo.so_luong++;
        } else {
          bill.push({
            ...combo,
            so_luong: 1,
            kich_co: "Combo",
            kich_co_id: null,
            gia_them: 0,
            toppings: [],
            tong_topping: 0,
          });
        }

        renderBill();
        Toast.success(`ƒê√£ th√™m ${combo.ten_combo} v√†o h√≥a ƒë∆°n`);
      }

      // ============================================
      // MAIN APPLICATION CODE
      // ============================================
      let bill = [];
      let billContainer, totalEl, emptyEl, kichCoList, toppingList;

      function renderBill() {
        if (!billContainer) return;

        billContainer.innerHTML = "";
        if (!bill.length) {
          emptyEl.style.display = "block";
        } else {
          emptyEl.style.display = "none";
          bill.forEach((item, i) => {
            const div = document.createElement("div");
            div.className =
              "flex justify-between items-center bg-gray-50 rounded-lg p-3 mb-2 shadow-sm cursor-pointer hover:bg-blue-50 transition";

            if (item.is_combo) {
              div.innerHTML = `
                <div class="flex-1">
                  <p class="font-semibold text-gray-800">${item.ten_combo} üéÅ</p>
                  <p class="text-sm text-gray-500">
                    Combo - ${item.gia_combo.toLocaleString()} ƒë
                  </p>
                  <p class="text-xs text-gray-400 mt-1">
                    ${item.san_pham.map((sp) => `${sp.ten_san_pham} (x${sp.so_luong})`).join(", ")}
                  </p>
                </div>
                <div class="flex items-center gap-2">
                  <button class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 text-gray-700" onclick="changeQty(${i},-1)">-</button>
                  <span class="w-6 text-center">${item.so_luong}</span>
                  <button class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 text-gray-700" onclick="changeQty(${i},1)">+</button>
                  <button class="ml-2 text-red-500 hover:text-red-700" onclick="removeItem(${i})">üóëÔ∏è</button>
                </div>
              `;
            } else {
              div.innerHTML = `
                <div class="flex-1" onclick="chonKichCoVaTopping(${i})">
                  <p class="font-semibold text-gray-800">${item.ten_san_pham}</p>
                  <p class="text-sm text-gray-500">
                    ${item.kich_co || "(Ch∆∞a ch·ªçn size)"} 
                    ${item.toppings.length ? " + " + item.toppings.map((t) => t.ten_topping).join(", ") : ""}
                    ‚Äî ${(Number(item.gia_co_ban) + Number(item.gia_them || 0) + Number(item.tong_topping || 0)).toLocaleString()} ƒë
                  </p>
                </div>
                <div class="flex items-center gap-2">
                  <button class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 text-gray-700" onclick="changeQty(${i},-1)">-</button>
                  <span class="w-6 text-center">${item.so_luong}</span>
                  <button class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 text-gray-700" onclick="changeQty(${i},1)">+</button>
                  <button class="ml-2 text-red-500 hover:text-red-700" onclick="removeItem(${i})">üóëÔ∏è</button>
                </div>
              `;
            }
            billContainer.appendChild(div);
          });
        }

        const total = bill.reduce((sum, item) => {
          if (item.is_combo) return sum + Number(item.gia_combo) * item.so_luong;
          return sum + (Number(item.gia_co_ban) + Number(item.gia_them || 0) + Number(item.tong_topping || 0)) * item.so_luong;
        }, 0);

        totalEl.textContent = total.toLocaleString() + " ƒë";
      }

      // ==========================
      // MEMBER DISCOUNT (THEO B·∫¨C)
      // ==========================
      const MEMBER_DISCOUNT = {
        tierMap: null,
        async loadTierMap() {
          if (this.tierMap) return this.tierMap;
          const res = await fetch("http://localhost:3000/bacthanhvien/laytatca");
          if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i b·∫≠c th√†nh vi√™n");
          const tiers = await res.json();
          this.tierMap = new Map((tiers || []).map((t) => [Number(t.bac_id), t]));
          return this.tierMap;
        },
        async getDiscountByBacId(bac_id) {
          if (!bac_id) return 0;
          const map = await this.loadTierMap();
          const tier = map.get(Number(bac_id));
          return tier ? Number(tier.phan_tram_giam || 0) : 0;
        },
      };

      function calcTongTienBan(monAn) {
        return (monAn || []).reduce((sum, item) => {
          if (item.is_combo) return sum + Number(item.gia_combo) * item.so_luong;
          return sum + (Number(item.gia_co_ban) + Number(item.gia_them || 0) + Number(item.tong_topping || 0)) * item.so_luong;
        }, 0);
      }

      function applyPercentDiscountToModal(modal, tongTienBan, percent, label = "") {
        const p = Math.max(0, Math.min(100, Number(percent || 0)));
        const tienSauGiam = tongTienBan * (1 - p / 100);

        modal.dataset.phanTramGiam = String(p);
        modal.dataset.tienSauGiam = String(tienSauGiam);

        const discountEl = modal.querySelector("#memberDiscountInfo");
        if (discountEl) {
          if (p > 0) {
            discountEl.textContent = `${label} Gi·∫£m ${p}% ‚Üí c√≤n ${tienSauGiam.toLocaleString("vi-VN")}ƒë`;
            discountEl.className = "text-blue-600 font-semibold text-sm";
          } else {
            discountEl.textContent = "";
          }
        }

        return tienSauGiam;
      }

      document.addEventListener("DOMContentLoaded", () => {
        billContainer = document.getElementById("bill");
        totalEl = document.getElementById("total");
        emptyEl = document.getElementById("empty");

        initTabs();
        loadCombos();
        loadSanPhamBanChay();

        kichCoList = [];
        fetch("/kichco/laytatca")
          .then((r) => r.json())
          .then((data) => (kichCoList = data))
          .catch(console.error);

        toppingList = [];
        fetch("/topping/laytatca")
          .then((r) => r.json())
          .then((data) => (toppingList = data))
          .catch(console.error);

        document.querySelectorAll(".product").forEach((el) => {
          el.addEventListener("click", () => {
            const sp = {
              san_pham_id: +el.dataset.id,
              ten_san_pham: el.dataset.ten,
              gia_co_ban: +el.dataset.gia,
              ten_loai: el.dataset.loai,
              kich_co: null,
              kich_co_id: null,
              gia_them: 0,
              toppings: [],
              tong_topping: 0,
            };
            addToBill(sp);
          });
        });

        function addToBill(sp) {
          const existing = bill.find((i) => i.san_pham_id === sp.san_pham_id && !i.kich_co && !i.is_combo);
          if (existing) existing.so_luong++;
          else bill.push({ ...sp, so_luong: 1 });
          renderBill();
        }

        window.chonKichCoVaTopping = (index) => {
          const item = bill[index];

          if (item.is_combo) {
            Toast.info("Combo ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p s·∫µn, kh√¥ng th·ªÉ thay ƒë·ªïi!");
            return;
          }

          if (!kichCoList.length) {
            Toast.error("Kh√¥ng c√≥ d·ªØ li·ªáu k√≠ch c·ª°!");
            return;
          }

          const modal = document.createElement("div");
          modal.className = "fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50 size-modal";
          modal.innerHTML = `
            <div class="bg-white rounded-3xl w-96 shadow-2xl border border-gray-100 flex flex-col overflow-hidden z-[1000]">
              <div class="p-6 border-b">
                <h2 class="text-lg font-semibold text-center text-gray-800">
                  Ch·ªçn t√πy ch·ªçn cho <br>
                  <span class="text-blue-600">${item.ten_san_pham}</span>
                </h2>
              </div>
              <div class="p-6 max-h-[75vh] overflow-y-auto pr-2 rounded-b-3xl">
                <div class="mb-6">
                  <h3 class="font-semibold text-gray-700 mb-2">K√≠ch c·ª°:</h3>
                  <div class="flex flex-col gap-2">
                    ${kichCoList
                      .map(
                        (kc) => `<label class="border border-gray-200 rounded-xl py-2 px-3 flex justify-between items-center hover:bg-blue-50 cursor-pointer transition">
                          <span class="text-center"><input class="mr-1 mt-1" type="radio" name="kichco" value='${JSON.stringify(kc)}' ${
                          item.kich_co === kc.ten_kich_co ? "checked" : ""
                        }>${kc.ten_kich_co}</span>
                          <span class="text-gray-600">+${kc.gia_them.toLocaleString()} ƒë</span>
                        </label>`
                      )
                      .join("")}
                  </div>
                </div>
                <div class="mb-6">
                  <h3 class="font-semibold text-gray-700 mb-2">Topping:</h3>
                  <div class="flex flex-col gap-2">
                    ${toppingList
                      .map(
                        (t) => `<label class="border border-gray-200 rounded-xl py-2 px-3 flex justify-between items-center hover:bg-blue-50 cursor-pointer transition">
                          <span><input class="mr-1 mt-1" type="checkbox" value='${JSON.stringify(t)}' ${
                          item.toppings.some((tp) => tp.topping_id === t.topping_id) ? "checked" : ""
                        }>${t.ten_topping}</span>
                          <span class="text-gray-600">+${t.gia_them.toLocaleString()} ƒë</span>
                        </label>`
                      )
                      .join("")}
                  </div>
                </div>
              </div>
              <div class="p-6 border-t flex gap-3">
                <button onclick="luuKichCoVaTopping(${index})"
                  class="flex-1 bg-blue-600 text-white py-2 rounded-xl hover:bg-blue-700 transition">
                  L∆∞u
                </button>
                <button onclick="dongSizeModal()"
                  class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-xl hover:bg-gray-300 transition">
                  H·ªßy
                </button>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
        };

        window.luuKichCoVaTopping = (index) => {
          const modal = document.querySelector(".size-modal");
          const item = bill[index];
          const kcInput = modal.querySelector('input[name="kichco"]:checked');
          if (!kcInput) {
            Toast.warning("Vui l√≤ng ch·ªçn k√≠ch c·ª°!");
            return;
          }
          const kc = JSON.parse(kcInput.value);
          item.kich_co = kc.ten_kich_co;
          item.kich_co_id = kc.kich_co_id;
          item.gia_them = kc.gia_them;

          const toppingInputs = modal.querySelectorAll('input[type="checkbox"]:checked');
          const toppings = Array.from(toppingInputs).map((i) => JSON.parse(i.value));
          item.toppings = toppings;
          item.tong_topping = toppings.reduce((sum, t) => sum + Number(t.gia_them), 0);

          dongSizeModal();
          renderBill();
          Toast.success("ƒê√£ l∆∞u t√πy ch·ªçn!");
        };

        window.dongSizeModal = () => document.querySelectorAll(".size-modal").forEach((m) => m.remove());

        window.changeQty = (i, d) => {
          bill[i].so_luong += d;
          if (bill[i].so_luong <= 0) bill.splice(i, 1);
          renderBill();
        };

        window.removeItem = (i) => {
          bill.splice(i, 1);
          renderBill();
          Toast.info("ƒê√£ x√≥a s·∫£n ph·∫©m");
        };

        // --- User ---
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user) window.location.href = "/taikhoan/dangnhap";
        else
          document.getElementById("tenNhanVien").textContent = `üëã Xin ch√†o, ${user.ho_ten || user.ten_dang_nhap || "Nh√¢n vi√™n"}`;

        document.getElementById("logoutBtn").addEventListener("click", () => {
          localStorage.removeItem("user");
          Toast.success("ƒêƒÉng xu·∫•t th√†nh c√¥ng!");
          setTimeout(() => {
            window.location.href = "/taikhoan/dangnhap";
          }, 1000);
        });

        // --- B√†n ---
        const chooseTableBtn = document.getElementById("chooseTableBtn");
        const completeBtn = document.getElementById("completeBtn");
        const banContainerEl = document.getElementById("banContainer");
        let banList = [],
          hoaDonTheoBan = {},
          selectedBanId = null;

        fetch("http://localhost:3000/ban/laytatca")
          .then((res) => res.json())
          .then((data) => {
            banList = data;
            renderBan();
          });

        const storedHoaDon = localStorage.getItem("hoaDonTheoBan");
        if (storedHoaDon) hoaDonTheoBan = JSON.parse(storedHoaDon);

        chooseTableBtn.addEventListener("click", () => {
          if (bill.length === 0) {
            Toast.warning("Vui l√≤ng ch·ªçn m√≥n tr∆∞·ªõc khi ch·ªçn b√†n!");
            return;
          }

          const spChuaChonKichCo = bill.find((item) => !item.is_combo && !item.kich_co);
          if (spChuaChonKichCo) {
            Toast.warning("Vui l√≤ng ch·ªçn k√≠ch c·ª° cho t·∫•t c·∫£ s·∫£n ph·∫©m!");
            return;
          }

          banContainerEl.classList.remove("hidden");
          renderBan();
        });

        function renderBan() {
          const banListEl = document.getElementById("banList");
          banListEl.innerHTML = "";
          hoaDonTheoBan = JSON.parse(localStorage.getItem("hoaDonTheoBan")) || {};

          banList.forEach((ban) => {
            let trangThai = ban.trang_thai;
            if (hoaDonTheoBan[ban.ban_id] && hoaDonTheoBan[ban.ban_id].length > 0 && ban.trang_thai !== "ƒê√£ thanh to√°n") {
              trangThai = "ƒêang s·ª≠ d·ª•ng";
            }

            const div = document.createElement("div");
            div.className = `p-3 rounded-lg text-center font-semibold cursor-pointer transition
              ${trangThai === "Tr·ªëng" ? "bg-green-200 hover:bg-green-300" : ""}
              ${trangThai === "ƒêang s·ª≠ d·ª•ng" ? "bg-yellow-200 hover:bg-yellow-300" : ""}
              ${trangThai === "ƒê√£ thanh to√°n" ? "bg-gray-300 cursor-not-allowed" : ""}`;
            div.textContent = `${ban.ten_ban} ‚Äî ${trangThai}`;

            if (trangThai !== "ƒê√£ thanh to√°n") div.addEventListener("click", () => selectBan(ban.ban_id));

            banListEl.appendChild(div);
          });
        }

        function selectBan(ban_id) {
          selectedBanId = ban_id;
          banContainerEl.classList.add("hidden");
          const tenBan = banList.find((b) => b.ban_id === ban_id).ten_ban;
          Toast.success(`ƒê√£ ch·ªçn ${tenBan}, nh·∫•n Ho√†n t·∫•t ƒë·ªÉ l∆∞u s·∫£n ph·∫©m`);
          completeBtn.classList.remove("hidden");
          chooseTableBtn.classList.add("hidden");
        }

        completeBtn.addEventListener("click", () => {
          if (!selectedBanId) {
            Toast.warning("Vui l√≤ng ch·ªçn b√†n!");
            return;
          }
          if (!hoaDonTheoBan[selectedBanId]) hoaDonTheoBan[selectedBanId] = [];
          hoaDonTheoBan[selectedBanId].push(...bill.map((item) => ({ ...item })));
          localStorage.setItem("hoaDonTheoBan", JSON.stringify(hoaDonTheoBan));
          bill.length = 0;
          renderBill();
          completeBtn.classList.add("hidden");
          chooseTableBtn.classList.remove("hidden");
          selectedBanId = null;
          renderBan();
          Toast.success("ƒê√£ l∆∞u s·∫£n ph·∫©m v√†o b√†n");
        });

        // --- Xem danh s√°ch b√†n + Thanh to√°n ---
        const viewBanContainerEl = document.getElementById("viewBanContainer");
        const viewTablesBtn = document.getElementById("viewTablesBtn");

        viewTablesBtn.addEventListener("click", () => {
          renderViewBan();
          viewBanContainerEl.classList.remove("hidden");
        });

        // ‚úÖ TH√äM: h√†m x√≥a m√≥n kh·ªèi b√†n
        function xoaMonKhoiBan(banId, tenBan) {
          const current = JSON.parse(localStorage.getItem("hoaDonTheoBan")) || {};
          const list = current[banId] || [];

          if (!list.length) {
            Toast.warning("B√†n n√†y ch∆∞a c√≥ m√≥n ƒë·ªÉ x√≥a!");
            return;
          }

          const ok = confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô m√≥n c·ªßa ${tenBan} kh√¥ng?`);
          if (!ok) return;

          delete current[banId];
          localStorage.setItem("hoaDonTheoBan", JSON.stringify(current));

          // c·∫≠p nh·∫≠t bi·∫øn ƒëang d√πng
          hoaDonTheoBan = current;

          // render l·∫°i UI
          renderViewBan();
          renderBan();
          Toast.success(`ƒê√£ x√≥a m√≥n c·ªßa ${tenBan}`);
        }

        function renderViewBan() {
          const viewBanGrid = document.getElementById("viewBanGrid");
          viewBanGrid.innerHTML = "";
          hoaDonTheoBan = JSON.parse(localStorage.getItem("hoaDonTheoBan")) || {};

          if (!banList.length) {
            viewBanGrid.innerHTML = '<p class="text-center text-gray-500 col-span-4">Ch∆∞a c√≥ b√†n n√†o</p>';
            return;
          }

          banList.forEach((ban) => {
            const banData = hoaDonTheoBan[ban.ban_id] || [];
            const div = document.createElement("div");
            div.className = "relative border p-3 rounded-lg shadow-sm bg-gray-50";
            div.innerHTML = `<p class="font-semibold mb-2">${ban.ten_ban}</p>`;

            if (!banData.length) {
              div.innerHTML += '<p class="text-gray-500">Ch∆∞a c√≥ s·∫£n ph·∫©m</p>';
            } else {
              const ul = document.createElement("ul");
              banData.forEach((item) => {
                const li = document.createElement("li");
                if (item.is_combo) li.textContent = `üéÅ ${item.ten_combo} x${item.so_luong}`;
                else
                  li.textContent = `${item.ten_san_pham} ${item.kich_co ? "(" + item.kich_co + ")" : ""} ${
                    item.toppings.length ? "+ " + item.toppings.map((t) => t.ten_topping).join(", ") : ""
                  } x${item.so_luong}`;
                ul.appendChild(li);
              });
              div.appendChild(ul);

              // N√∫t thanh to√°n
              const payBtn = document.createElement("button");
              payBtn.className =
                "absolute top-2 right-2 w-10 h-10 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center justify-center font-semibold";
              payBtn.textContent = "üí∞";

              // ‚úÖ N√öT X√ìA NGAY D∆Ø·ªöI N√öT THANH TO√ÅN
              const delBtn = document.createElement("button");
              delBtn.className =
                "absolute top-14 right-2 w-10 h-10 bg-red-500 hover:bg-red-600 text-white rounded-lg flex items-center justify-center font-semibold";
              delBtn.textContent = "üóëÔ∏è";
              delBtn.title = "X√≥a m√≥n kh·ªèi b√†n";

              delBtn.addEventListener("click", () => {
                xoaMonKhoiBan(ban.ban_id, ban.ten_ban);
              });

              payBtn.addEventListener("click", () => {
                const modal = document.createElement("div");
                modal.className = "fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-40";
                modal.style.zIndex = "9999";
                modal.innerHTML = `
                  <div class="bg-white rounded-2xl p-6 shadow-lg w-full max-w-2xl mx-auto">
                    <div class="flex flex-col md:flex-row gap-6">
                      <div class="flex-1 flex flex-col gap-4">
                        <div class="flex gap-2">
                          <input id="memberPhoneInput" type="text" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i th√†nh vi√™n..." class="flex-1 px-2 py-1.5 text-sm rounded-lg border text-gray-800 focus:outline-none focus:ring-2 focus:ring-yellow-400"/>
                          <button id="searchMemberBtn" class="bg-blue-500 hover:bg-blue-600 text-white py-1.5 px-3 text-sm rounded-lg font-semibold transition">üîç T√¨m ki·∫øm</button>
                        </div>
                        <p id="memberName" class="text-green-600 font-semibold text-sm truncate"></p>
                        <p id="memberDiscountInfo" class="text-blue-600 font-semibold text-sm truncate"></p>
                        <div class="flex gap-2">
                          <input id="promoCodeInput" type="text" placeholder="Nh·∫≠p m√£ khuy·∫øn m√£i..." class="flex-1 px-2 py-1.5 text-sm rounded-lg border text-gray-800 focus:outline-none focus:ring-2 focus:ring-yellow-400"/>
                          <button id="applyBtn" class="bg-yellow-400 hover:bg-yellow-500 text-white py-1.5 px-3 text-sm rounded-lg font-semibold transition">√Åp d·ª•ng</button>
                        </div>
                      </div>
                      <div class="flex-1 flex flex-col gap-3">
                        <h2 class="text-lg font-semibold mb-2 text-left">Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n</h2>
                        <button id="cashBtn" class="bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg font-semibold w-full">üíµ Ti·ªÅn m·∫∑t</button>
                        <button id="bankingBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white py-2 rounded-lg font-semibold w-full">üè¶ Banking</button>
                        <button id="cancelBtn" class="bg-gray-200 hover:bg-gray-300 py-2 rounded-lg font-semibold w-full">H·ªßy</button>
                      </div>
                    </div>
                  </div>
                `;
                document.body.appendChild(modal);

                // ====== APPLY PROMO CODE (∆ØU TI√äN M√É, GHI ƒê√à GI·∫¢M B·∫¨C) ======
                const applyBtn = modal.querySelector("#applyBtn");
                const promoInput = modal.querySelector("#promoCodeInput");

                applyBtn.addEventListener("click", async () => {
                  const ma_khuyen_mai = promoInput.value.trim();
                  const thanh_vien_id = modal.dataset.memberId;

                  if (!ma_khuyen_mai) {
                    Toast.warning("Vui l√≤ng nh·∫≠p m√£ khuy·∫øn m√£i!");
                    return;
                  }
                  if (!thanh_vien_id) {
                    Toast.warning("Vui l√≤ng t√¨m th√†nh vi√™n tr∆∞·ªõc khi √°p d·ª•ng m√£!");
                    return;
                  }

                  try {
                    const res = await fetch("http://localhost:3000/mucgiamgia/kiemTraMaChoThanhVien", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ ma_khuyen_mai, thanh_vien_id }),
                    });
                    const data = await res.json();

                    if (res.ok && data.error === 0) {
                      Toast.success("üéâ √Åp d·ª•ng m√£ khuy·∫øn m√£i th√†nh c√¥ng!");
                      console.log("üéüÔ∏è M√£ khuy·∫øn m√£i h·ª£p l·ªá:", data.data);

                      modal.dataset.mucGiamGiaId = data.data.muc_giam_gia_id;

                      const monAn = hoaDonTheoBan[ban.ban_id] || [];
                      const tongTienBan = calcTongTienBan(monAn);

                      applyPercentDiscountToModal(modal, tongTienBan, Number(data.data.phan_tram_giam), "üéüÔ∏è M√£ KM:");
                    } else {
                      Toast.error("‚ùå M√£ khuy·∫øn m√£i kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng!");
                    }
                  } catch (err) {
                    console.error(err);
                    Toast.error("‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server!");
                  }
                });

                // ====== SEARCH MEMBER -> APPLY TIER DISCOUNT ======
                modal.querySelector("#searchMemberBtn").addEventListener("click", async () => {
                  const sdt = modal.querySelector("#memberPhoneInput").value.trim();
                  if (!sdt) {
                    Toast.warning("Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i!");
                    return;
                  }

                  try {
                    const res = await fetch(`http://localhost:3000/thanhvien/timtheosdt/${sdt}`);
                    if (!res.ok) throw new Error("Kh√¥ng t√¨m th·∫•y th√†nh vi√™n");
                    const member = await res.json();

                    console.log("üîç Th√¥ng tin th√†nh vi√™n t√¨m th·∫•y:", member);

                    modal.querySelector("#memberName").textContent = `üë§ ${member.ho_ten}`;
                    modal.dataset.memberId = member.thanh_vien_id;

                    modal.dataset.bacId = member.bac_id ?? "";

                    const monAn = hoaDonTheoBan[ban.ban_id] || [];
                    const tongTienBan = calcTongTienBan(monAn);

                    const percentTier = await MEMBER_DISCOUNT.getDiscountByBacId(member.bac_id);

                    const hasPromoApplied = !!modal.dataset.mucGiamGiaId;
                    if (!hasPromoApplied) {
                      applyPercentDiscountToModal(modal, tongTienBan, percentTier, "üéñÔ∏è Theo b·∫≠c:");
                    } else {
                      Toast.info("ƒê√£ t√¨m th·∫•y th√†nh vi√™n (ƒëang √°p d·ª•ng ∆∞u ƒë√£i theo m√£ KM)!");
                    }

                    Toast.success("T√¨m th·∫•y th√†nh vi√™n!");
                  } catch (err) {
                    Toast.error("Kh√¥ng t√¨m th·∫•y th√†nh vi√™n!");
                    modal.querySelector("#memberName").textContent = "";
                    modal.querySelector("#memberDiscountInfo").textContent = "";
                    modal.dataset.memberId = "";
                    modal.dataset.bacId = "";
                    delete modal.dataset.phanTramGiam;
                    delete modal.dataset.tienSauGiam;
                    console.error(err);
                  }
                });

                // ====== CASH PAYMENT ======
                modal.querySelector("#cashBtn").addEventListener("click", async () => {
                  const monAn = hoaDonTheoBan[ban.ban_id] || [];
                  if (!monAn.length) {
                    Toast.warning("B√†n n√†y ch∆∞a c√≥ m√≥n!");
                    return;
                  }

                  const tongTienBan = calcTongTienBan(monAn);

                  const phanTramGiam = modal.dataset.phanTramGiam ? Number(modal.dataset.phanTramGiam) : 0;
                  const tienSauGiam = tongTienBan * (1 - phanTramGiam / 100);

                  const chiTiet = [];
                  monAn.forEach((item) => {
                    if (item.is_combo) {
                      item.san_pham.forEach((sp) => {
                        chiTiet.push({
                          san_pham_id: sp.san_pham_id,
                          kich_co_id: null,
                          topping_id: null,
                          so_luong: sp.so_luong * item.so_luong,
                          don_gia: 0,
                          is_combo: true,
                          combo_id: item.combo_id,
                        });
                      });
                    } else {
                      const donGia = Number(item.gia_co_ban) + Number(item.gia_them || 0) + Number(item.tong_topping || 0);
                      if (item.toppings.length) {
                        item.toppings.forEach((t) => {
                          chiTiet.push({
                            san_pham_id: item.san_pham_id,
                            kich_co_id: item.kich_co_id,
                            topping_id: t.topping_id,
                            so_luong: item.so_luong,
                            don_gia: donGia,
                          });
                        });
                      } else {
                        chiTiet.push({
                          san_pham_id: item.san_pham_id,
                          kich_co_id: item.kich_co_id,
                          topping_id: null,
                          so_luong: item.so_luong,
                          don_gia: donGia,
                        });
                      }
                    }
                  });

                  const payload = {
                    thanh_vien_id: modal.dataset.memberId || null,
                    ban_id: ban.ban_id,
                    tai_khoan_id: user.tai_khoan_id || 1,
                    tong_tien: tongTienBan,
                    tien_sau_giam: tienSauGiam,
                    muc_giam_gia_id: modal.dataset.mucGiamGiaId || null,
                    trang_thai: "ƒê√£ thanh to√°n",
                    chi_tiet: chiTiet,
                  };

                  try {
                    const res = await fetch("http://localhost:3000/donhang/them", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify(payload),
                    });
                    const data = await res.json();

                    if (res.ok) {
                      Toast.success("ƒê√£ l∆∞u ƒë∆°n h√†ng th√†nh c√¥ng!");

                      if (modal.dataset.mucGiamGiaId && modal.dataset.memberId) {
                        const thanhVien = {
                          thanh_vien_id: modal.dataset.memberId,
                          da_su_dung: 1,
                          ten_thanh_vien: modal.querySelector("#memberName").textContent.replace("üë§ ", ""),
                        };

                        await fetch(`http://localhost:3000/mucgiamgia/capnhatthongtin/${modal.dataset.mucGiamGiaId}`, {
                          method: "PUT",
                          headers: { "Content-Type": "application/json" },
                          body: JSON.stringify(thanhVien),
                        });
                      }

                      delete hoaDonTheoBan[ban.ban_id];
                      localStorage.setItem("hoaDonTheoBan", JSON.stringify(hoaDonTheoBan));
                      renderViewBan();
                      renderBan();
                      loadSanPhamBanChay();
                    } else {
                      Toast.error("L·ªói khi l∆∞u ƒë∆°n h√†ng: " + (data.message || JSON.stringify(data)));
                      console.error(data);
                    }
                  } catch (err) {
                    console.error(err);
                    Toast.error("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server!");
                  }

                  modal.remove();
                });

                // ====== BANKING PAYMENT ======
                modal.querySelector("#bankingBtn").addEventListener("click", async () => {
                  const monAn = hoaDonTheoBan[ban.ban_id] || [];
                  if (!monAn.length) {
                    Toast.warning("B√†n n√†y ch∆∞a c√≥ m√≥n!");
                    return;
                  }

                  const tongTienBan = calcTongTienBan(monAn);

                  const phanTramGiam = modal.dataset.phanTramGiam ? Number(modal.dataset.phanTramGiam) : 0;
                  const tienSauGiam = tongTienBan * (1 - phanTramGiam / 100);

                  const payosItems = [];
                  monAn.forEach((item) => {
                    if (item.is_combo) {
                      payosItems.push({
                        name: `üéÅ ${item.ten_combo}`,
                        quantity: item.so_luong,
                        price: Math.round(Number(item.gia_combo)),
                      });
                    } else {
                      let itemName = item.ten_san_pham;
                      if (item.kich_co) itemName += ` (${item.kich_co})`;
                      if (item.toppings.length) itemName += ` + ${item.toppings.map((t) => t.ten_topping).join(", ")}`;

                      const itemPrice = Number(item.gia_co_ban) + Number(item.gia_them || 0) + Number(item.tong_topping || 0);

                      payosItems.push({
                        name: itemName,
                        quantity: item.so_luong,
                        price: Math.round(itemPrice),
                      });
                    }
                  });

                  const tenBan = banList.find((b) => b.ban_id === ban.ban_id).ten_ban;
                  const shortDescription = `${tenBan} - Coffee`.substring(0, 25);

                  const payosPayload = {
                    amount: Math.round(tienSauGiam),
                    description: shortDescription,
                    returnUrl: `${window.location.origin}/view/pos?payment=success&ban_id=${ban.ban_id}`,
                    cancelUrl: `${window.location.origin}/view/pos?payment=cancel`,
                    items: payosItems,
                  };

                  const chiTiet = [];
                  monAn.forEach((item) => {
                    if (item.is_combo) {
                      item.san_pham.forEach((sp) => {
                        chiTiet.push({
                          san_pham_id: sp.san_pham_id,
                          kich_co_id: null,
                          topping_id: null,
                          so_luong: sp.so_luong * item.so_luong,
                          don_gia: 0,
                          is_combo: true,
                          combo_id: item.combo_id,
                        });
                      });
                    } else {
                      const donGia = Number(item.gia_co_ban) + Number(item.gia_them || 0) + Number(item.tong_topping || 0);
                      if (item.toppings.length) {
                        item.toppings.forEach((t) => {
                          chiTiet.push({
                            san_pham_id: item.san_pham_id,
                            kich_co_id: item.kich_co_id,
                            topping_id: t.topping_id,
                            so_luong: item.so_luong,
                            don_gia: donGia,
                          });
                        });
                      } else {
                        chiTiet.push({
                          san_pham_id: item.san_pham_id,
                          kich_co_id: item.kich_co_id,
                          topping_id: null,
                          so_luong: item.so_luong,
                          don_gia: donGia,
                        });
                      }
                    }
                  });

                  const tenThanhVien = modal.dataset.memberId ? modal.querySelector("#memberName").textContent.replace("üë§ ", "").trim() : null;

                  const orderData = {
                    thanh_vien_id: modal.dataset.memberId || null,
                    ban_id: ban.ban_id,
                    tai_khoan_id: user.tai_khoan_id || 1,
                    tong_tien: tongTienBan,
                    tien_sau_giam: tienSauGiam,
                    muc_giam_gia_id: modal.dataset.mucGiamGiaId || null,
                    ten_thanh_vien: tenThanhVien,
                    trang_thai: "Ch·ªù thanh to√°n",
                    chi_tiet: chiTiet,
                  };

                  sessionStorage.setItem(`pending_order_${ban.ban_id}`, JSON.stringify(orderData));

                  try {
                    const res = await fetch("http://localhost:3000/order/create-payment-link", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify(payosPayload),
                    });

                    const data = await res.json();
                    if (data.error === 0 && data.data?.checkoutUrl) {
                      Toast.success("ƒêang chuy·ªÉn ƒë·∫øn trang thanh to√°n...");
                      modal.remove();
                      setTimeout(() => {
                        window.location.href = data.data.checkoutUrl;
                      }, 1000);
                    } else {
                      throw new Error(data.message || "Kh√¥ng th·ªÉ t·∫°o li√™n k·∫øt thanh to√°n");
                    }
                  } catch (err) {
                    console.error("‚ùå L·ªói:", err);
                    Toast.error(`Kh√¥ng th·ªÉ t·∫°o li√™n k·∫øt thanh to√°n!\n\nL·ªói: ${err.message}`);
                  }
                });

                modal.querySelector("#cancelBtn").addEventListener("click", () => modal.remove());
              });

              div.appendChild(payBtn);
              div.appendChild(delBtn); // ‚úÖ th√™m n√∫t x√≥a
            }

            viewBanGrid.appendChild(div);
          });
        }

        window.closeViewBanModal = () => {
          viewBanContainerEl.classList.add("hidden");
        };

        // --- T√¨m ki·∫øm & l·ªçc ---
        const searchInput = document.getElementById("search");
        const filterSelect = document.getElementById("filter");
        const allProducts = Array.from(document.querySelectorAll(".product"));

        function filterProducts() {
          const keyword = searchInput.value.toLowerCase().trim();
          const selectedLoai = filterSelect.value;
          allProducts.forEach((p) => {
            const ten = p.dataset.ten.toLowerCase();
            const loai = p.dataset.loai;
            const matchTen = ten.includes(keyword);
            const matchLoai = selectedLoai === "" || loai === selectedLoai;
            p.style.display = matchTen && matchLoai ? "" : "none";
          });
        }

        searchInput.addEventListener("input", filterProducts);
        filterSelect.addEventListener("change", filterProducts);

        // --- X·ª¨ L√ù K·∫æT QU·∫¢ THANH TO√ÅN T·ª™ PAYOS ---
        const urlParams = new URLSearchParams(window.location.search);
        const paymentStatus = urlParams.get("payment");
        const banIdFromUrl = urlParams.get("ban_id");

        if (paymentStatus === "success" && banIdFromUrl) {
          (async () => {
            const orderData = JSON.parse(sessionStorage.getItem(`pending_order_${banIdFromUrl}`));

            if (orderData) {
              orderData.trang_thai = "ƒê√£ thanh to√°n";

              try {
                const res = await fetch("http://localhost:3000/donhang/them", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(orderData),
                });

                if (res.ok) {
                  if (orderData.muc_giam_gia_id && orderData.thanh_vien_id) {
                    const updatePayload = {
                      thanh_vien_id: orderData.thanh_vien_id,
                      da_su_dung: 1,
                      ten_thanh_vien: orderData.ten_thanh_vien || "Th√†nh vi√™n",
                    };

                    await fetch(`http://localhost:3000/mucgiamgia/capnhatthongtin/${orderData.muc_giam_gia_id}`, {
                      method: "PUT",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify(updatePayload),
                    });
                  }

                  delete hoaDonTheoBan[banIdFromUrl];
                  localStorage.setItem("hoaDonTheoBan", JSON.stringify(hoaDonTheoBan));
                  sessionStorage.removeItem(`pending_order_${banIdFromUrl}`);

                  loadSanPhamBanChay();

                  Toast.success("üéâ Thanh to√°n th√†nh c√¥ng!", 2000);
                  setTimeout(() => {
                    window.location.href = "/view/pos";
                  }, 2000);
                } else {
                  Toast.error("L·ªói khi l∆∞u ƒë∆°n h√†ng!");
                  setTimeout(() => {
                    window.location.href = "/view/pos";
                  }, 2000);
                }
              } catch (err) {
                console.error("‚ùå L·ªói khi l∆∞u ƒë∆°n h√†ng:", err);
                Toast.error("Kh√¥ng th·ªÉ l∆∞u ƒë∆°n h√†ng!");
                setTimeout(() => {
                  window.location.href = "/view/pos";
                }, 2000);
              }
            } else {
              setTimeout(() => {
                window.location.href = "/view/pos";
              }, 1000);
            }
          })();
        } else if (paymentStatus === "cancel") {
          Toast.warning("Thanh to√°n ƒë√£ b·ªã h·ªßy. ƒê∆°n h√†ng v·∫´n ƒë∆∞·ª£c gi·ªØ nguy√™n.");
          setTimeout(() => {
            window.location.href = "/view/pos";
          }, 2000);
        }

        // ‚úÖ ƒë√≥ng modal ch·ªçn b√†n (b·∫°n c√≥ n√∫t nh∆∞ng ch∆∞a g·∫Øn event trong b·∫£n g·ª≠i)
        document.getElementById("closeBanBtn").addEventListener("click", () => {
          banContainerEl.classList.add("hidden");
        });
      });
    </script>
  </body>
</html>
