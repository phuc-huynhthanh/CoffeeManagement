<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="/assets/coffee.png" type="image/png" />
    <title>Brother's Hai Coffee</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 flex flex-col min-h-screen">
    <!-- Header -->
    <header
      class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-4 flex justify-between items-center shadow-md"
    >
      <h1 class="text-2xl font-bold tracking-wide">‚òïBrother's Hai Coffee</h1>
      <div class="flex gap-3 items-center">
        <input
          id="search"
          type="text"
          placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..."
          class="px-4 py-2 rounded-lg text-gray-800 w-64 focus:outline-none focus:ring-2 focus:ring-yellow-400"
        />
        <select id="filter" class="px-3 py-2 rounded-lg text-gray-800">
          <option value="">T·∫•t c·∫£ lo·∫°i</option>
          <% loai.forEach(l => { %>
          <option value="<%= l %>"><%= l %></option>
          <% }) %>
        </select>
        <div
          class="flex items-center gap-2 bg-white text-gray-800 px-3 py-1 rounded-full shadow-md"
        >
          <p id="tenNhanVien" class="font-semibold text-sm"></p>
          <button
            id="logoutBtn"
            class="ml-2 text-red-500 hover:text-red-700 font-semibold text-sm"
          >
            ƒêƒÉng xu·∫•t
          </button>
        </div>
      </div>
    </header>

    <!-- N·ªôi dung -->
    <div class="flex flex-1 overflow-hidden">
      <!-- Danh s√°ch s·∫£n ph·∫©m -->
      <main
        id="product-list"
        class="flex-1 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-5 gap-6 p-6 overflow-y-scroll max-h-[calc(100vh-100px)] scrollbar-thin scrollbar-thumb-gray-400 scrollbar-track-gray-200"
      >
        <% sanPham.forEach(p => { %>
        <div
          class="product bg-white rounded-2xl shadow hover:shadow-xl hover:scale-105 transform transition cursor-pointer flex flex-col items-center text-center p-4"
          data-id="<%= p.san_pham_id %>"
          data-ten="<%= p.ten_san_pham %>"
          data-gia="<%= p.gia_co_ban %>"
          data-loai="<%= p.ten_loai %>"
        >
          <img
            src="<%= p.hinh_anh %>"
            alt="<%= p.ten_san_pham %>"
            class="w-28 h-28 object-cover rounded-xl mb-3"
          />
          <h3 class="text-lg font-semibold text-gray-800">
            <%= p.ten_san_pham %>
          </h3>
          <p class="text-gray-500 text-sm mb-1"><%= p.ten_loai %></p>
          <p class="text-blue-600 font-bold">
            <%= Number(p.gia_co_ban).toLocaleString() %> ƒë
          </p>
        </div>
        <% }) %>
      </main>

      <!-- H√≥a ƒë∆°n + N√∫t -->
      <aside
        class="w-full mt-2 sm:w-96 bg-white shadow-xl border-l rounded-tl-2xl flex flex-col"
      >
        <div
          class="p-4 bg-blue-600 text-white font-semibold text-lg rounded-tl-2xl"
        >
          üßæ H√≥a ƒë∆°n
        </div>
        <div id="bill" class="flex-1 p-4 overflow-y-auto">
          <p id="empty" class="text-gray-400 text-center mt-10">
            Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o
          </p>
        </div>
        <div class="border-t p-4 bg-gray-50 flex flex-col gap-2">
          <div class="flex justify-between mb-2 text-lg">
            <span>T·ªïng ti·ªÅn:</span>
            <span id="total" class="font-bold text-blue-600">0 ƒë</span>
          </div>
          <button
            id="chooseTableBtn"
            class="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-3 rounded-xl font-semibold transition"
          >
            üçΩ Ch·ªçn b√†n
          </button>
          <button
            id="completeBtn"
            class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-semibold transition hidden"
          >
            ‚úÖ Ho√†n t·∫•t
          </button>
          <button
            id="viewTablesBtn"
            class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-semibold transition"
          >
            üëÄ Xem danh s√°ch b√†n
          </button>
        </div>
        <!-- H√≥a ƒë∆°n theo b√†n -->
        <div id="billContainer" class="p-4"></div>
      </aside>
    </div>

    <!-- Modal danh s√°ch b√†n -->
    <div
      id="banContainer"
      class="hidden fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-40"
    >
      <div
        class="bg-white rounded-2xl shadow-xl p-6 w-11/12 max-w-5xl max-h-[80vh] overflow-y-auto"
      >
        <h2 class="text-lg font-semibold mb-4 text-center">Ch·ªçn b√†n</h2>
        <div id="banList" class="grid grid-cols-4 gap-4"></div>
        <button
          id="closeBanBtn"
          class="mt-4 w-full bg-gray-200 py-2 rounded-lg hover:bg-gray-300"
        >
          ƒê√≥ng
        </button>
      </div>
    </div>

    <!-- Modal xem danh s√°ch b√†n + m√≥n -->
    <div
      id="viewBanContainer"
      class="hidden fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-40"
    >
      <div
        class="bg-white rounded-2xl shadow-xl w-11/12 max-w-5xl h-[80vh] flex flex-col"
      >
        <!-- Header -->
        <div class="p-6 border-b">
          <h2 class="text-lg font-semibold text-center">Danh s√°ch b√†n</h2>
        </div>

        <!-- N·ªôi dung b√†n scrollable -->
        <div id="viewBanList" class="p-6 flex-1 overflow-y-auto">
          <div
            id="viewBanGrid"
            class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"
          >
            <!-- C√°c b√†n s·∫Ω ƒë∆∞·ª£c JS render v√†o ƒë√¢y -->
          </div>
        </div>

        <!-- Footer: N√∫t ƒê√≥ng c·ªë ƒë·ªãnh -->
        <div class="p-4 border-t flex-shrink-0">
          <button
            onclick="closeViewBanModal()"
            class="w-full bg-gray-200 py-2 rounded-lg hover:bg-gray-300 font-semibold"
          >
            ƒê√≥ng
          </button>
        </div>
      </div>
    </div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const bill = [];
    const billContainer = document.getElementById("bill");
    const totalEl = document.getElementById("total");
    const emptyEl = document.getElementById("empty");

    let kichCoList = [];
    fetch("/kichco/laytatca")
      .then((r) => r.json())
      .then((data) => (kichCoList = data))
      .catch(console.error);

    let toppingList = [];
    fetch("/topping/laytatca")
      .then((r) => r.json())
      .then((data) => (toppingList = data))
      .catch(console.error);

    // --- Th√™m s·∫£n ph·∫©m v√†o bill ---
    document.querySelectorAll(".product").forEach((el) => {
      el.addEventListener("click", () => {
        const sp = {
          san_pham_id: +el.dataset.id,
          ten_san_pham: el.dataset.ten,
          gia_co_ban: +el.dataset.gia,
          ten_loai: el.dataset.loai,
          kich_co: null,
          kich_co_id: null,
          gia_them: 0,
          toppings: [],
          tong_topping: 0,
        };
        addToBill(sp);
      });
    });

    function addToBill(sp) {
      const existing = bill.find(
        (i) => i.san_pham_id === sp.san_pham_id && !i.kich_co
      );
      if (existing) existing.so_luong++;
      else bill.push({ ...sp, so_luong: 1 });
      renderBill();
    }

    function renderBill() {
      billContainer.innerHTML = "";
      if (!bill.length) emptyEl.style.display = "block";
      else {
        emptyEl.style.display = "none";
        bill.forEach((item, i) => {
          const div = document.createElement("div");
          div.className =
            "flex justify-between items-center bg-gray-50 rounded-lg p-3 mb-2 shadow-sm cursor-pointer hover:bg-blue-50 transition";
          div.innerHTML = `
          <div class="flex-1" onclick="chonKichCoVaTopping(${i})">
            <p class="font-semibold text-gray-800">${item.ten_san_pham}</p>
            <p class="text-sm text-gray-500">
              ${item.kich_co || "(Ch∆∞a ch·ªçn size)"} 
              ${item.toppings.length ? " + " + item.toppings.map((t) => t.ten_topping).join(", ") : ""}
              ‚Äî ${(Number(item.gia_co_ban) + Number(item.gia_them || 0) + Number(item.tong_topping || 0)).toLocaleString()} ƒë
            </p>
          </div>
          <div class="flex items-center gap-2">
            <button class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 text-gray-700" onclick="changeQty(${i},-1)">-</button>
            <span class="w-6 text-center">${item.so_luong}</span>
            <button class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 text-gray-700" onclick="changeQty(${i},1)">+</button>
            <button class="ml-2 text-red-500 hover:text-red-700" onclick="removeItem(${i})">üóëÔ∏è</button>
          </div>
        `;
          billContainer.appendChild(div);
        });
      }

      const total = bill.reduce(
        (sum, item) =>
          sum +
          (Number(item.gia_co_ban) +
            Number(item.gia_them || 0) +
            Number(item.tong_topping || 0)) *
            item.so_luong,
        0
      );
      totalEl.textContent = total.toLocaleString() + " ƒë";
    }

    window.chonKichCoVaTopping = (index) => {
      if (!kichCoList.length) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu k√≠ch c·ª°!");
      const item = bill[index];
      const modal = document.createElement("div");
      modal.className =
        "fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50 size-modal";
      modal.innerHTML = `
        <div class="bg-white rounded-3xl w-96 shadow-2xl border border-gray-100 flex flex-col overflow-hidden">
          <div class="p-6 border-b">
            <h2 class="text-lg font-semibold text-center text-gray-800">
              Ch·ªçn t√πy ch·ªçn cho <br>
              <span class="text-blue-600">${item.ten_san_pham}</span>
            </h2>
          </div>
          <div class="p-6 max-h-[75vh] overflow-y-auto pr-2 rounded-b-3xl">
            <div class="mb-6">
              <h3 class="font-semibold text-gray-700 mb-2">K√≠ch c·ª°:</h3>
              <div class="flex flex-col gap-2">
                ${kichCoList
                  .map(
                    (kc) => `<label class="border border-gray-200 rounded-xl py-2 px-3 flex justify-between items-center hover:bg-blue-50 cursor-pointer transition">
                      <span class="text-center"><input class="mr-1 mt-1" type="radio" name="kichco" value='${JSON.stringify(
                        kc
                      )}' ${item.kich_co === kc.ten_kich_co ? "checked" : ""}>${kc.ten_kich_co}</span>
                      <span class="text-gray-600">+${kc.gia_them.toLocaleString()} ƒë</span>
                    </label>`
                  )
                  .join("")}
              </div>
            </div>
            <div class="mb-6">
              <h3 class="font-semibold text-gray-700 mb-2">Topping:</h3>
              <div class="flex flex-col gap-2">
                ${toppingList
                  .map(
                    (t) => `<label class="border border-gray-200 rounded-xl py-2 px-3 flex justify-between items-center hover:bg-blue-50 cursor-pointer transition">
                      <span><input class="mr-1 mt-1" type="checkbox" value='${JSON.stringify(
                        t
                      )}' ${item.toppings.some((tp) => tp.topping_id === t.topping_id) ? "checked" : ""}>${t.ten_topping}</span>
                      <span class="text-gray-600">+${t.gia_them.toLocaleString()} ƒë</span>
                    </label>`
                  )
                  .join("")}
              </div>
            </div>
          </div>
          <div class="p-6 border-t flex gap-3">
            <button onclick="luuKichCoVaTopping(${index})"
              class="flex-1 bg-blue-600 text-white py-2 rounded-xl hover:bg-blue-700 transition">
              L∆∞u
            </button>
            <button onclick="dongSizeModal()"
              class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-xl hover:bg-gray-300 transition">
              H·ªßy
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    };

    window.luuKichCoVaTopping = (index) => {
      const modal = document.querySelector(".size-modal");
      const item = bill[index];
      const kcInput = modal.querySelector('input[name="kichco"]:checked');
      if (!kcInput) return alert("Vui l√≤ng ch·ªçn k√≠ch c·ª°!");
      const kc = JSON.parse(kcInput.value);
      item.kich_co = kc.ten_kich_co;
      item.kich_co_id = kc.kich_co_id;
      item.gia_them = kc.gia_them;

      const toppingInputs = modal.querySelectorAll('input[type="checkbox"]:checked');
      const toppings = Array.from(toppingInputs).map((i) => JSON.parse(i.value));
      item.toppings = toppings;
      item.tong_topping = toppings.reduce((sum, t) => sum + Number(t.gia_them), 0);

      dongSizeModal();
      renderBill();
    };

    window.dongSizeModal = () =>
      document.querySelectorAll(".size-modal").forEach((m) => m.remove());
    window.changeQty = (i, d) => {
      bill[i].so_luong += d;
      if (bill[i].so_luong <= 0) bill.splice(i, 1);
      renderBill();
    };
    window.removeItem = (i) => {
      bill.splice(i, 1);
      renderBill();
    };

    // --- User ---
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) window.location.href = "/taikhoan/dangnhap";
    else
      document.getElementById("tenNhanVien").textContent = `üëã Xin ch√†o, ${
        user.ho_ten || user.ten_dang_nhap || "Nh√¢n vi√™n"
      }`;

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("user");
      window.location.href = "/taikhoan/dangnhap";
    });

    // --- B√†n ---
    const chooseTableBtn = document.getElementById("chooseTableBtn");
    const completeBtn = document.getElementById("completeBtn");
    const banContainerEl = document.getElementById("banContainer");
    let banList = [],
      hoaDonTheoBan = {},
      selectedBanId = null;

    fetch("http://localhost:3000/ban/laytatca")
      .then((res) => res.json())
      .then((data) => {
        banList = data;
        renderBan();
      });

    const storedHoaDon = localStorage.getItem("hoaDonTheoBan");
    if (storedHoaDon) hoaDonTheoBan = JSON.parse(storedHoaDon);

    chooseTableBtn.addEventListener("click", () => {
      if (bill.length === 0) return alert("Vui l√≤ng ch·ªçn m√≥n tr∆∞·ªõc khi ch·ªçn b√†n!");
      const spChuaChonKichCo = bill.find((item) => !item.kich_co);
      if (spChuaChonKichCo) return alert("Vui l√≤ng ch·ªçn k√≠ch c·ª° cho t·∫•t c·∫£ s·∫£n ph·∫©m!");
      banContainerEl.classList.remove("hidden");
      renderBan();
    });

    function renderBan() {
      const banListEl = document.getElementById("banList");
      banListEl.innerHTML = "";
      hoaDonTheoBan = JSON.parse(localStorage.getItem("hoaDonTheoBan")) || {};

      banList.forEach((ban) => {
        let trangThai = ban.trang_thai;
        if (
          hoaDonTheoBan[ban.ban_id] &&
          hoaDonTheoBan[ban.ban_id].length > 0 &&
          ban.trang_thai !== "ƒê√£ thanh to√°n"
        ) {
          trangThai = "ƒêang s·ª≠ d·ª•ng";
        }

        const div = document.createElement("div");
        div.className = `p-3 rounded-lg text-center font-semibold cursor-pointer transition
          ${trangThai === "Tr·ªëng" ? "bg-green-200 hover:bg-green-300" : ""}
          ${trangThai === "ƒêang s·ª≠ d·ª•ng" ? "bg-yellow-200 hover:bg-yellow-300" : ""}
          ${trangThai === "ƒê√£ thanh to√°n" ? "bg-gray-300 cursor-not-allowed" : ""}`;
        div.textContent = `${ban.ten_ban} ‚Äî ${trangThai}`;

        if (trangThai !== "ƒê√£ thanh to√°n")
          div.addEventListener("click", () => selectBan(ban.ban_id));

        banListEl.appendChild(div);
      });
    }

    function selectBan(ban_id) {
      selectedBanId = ban_id;
      banContainerEl.classList.add("hidden");
      alert(
        `B·∫°n ƒë√£ ch·ªçn ${banList.find((b) => b.ban_id === ban_id).ten_ban}, nh·∫•n Ho√†n t·∫•t ƒë·ªÉ l∆∞u s·∫£n ph·∫©m`
      );
      completeBtn.classList.remove("hidden");
      chooseTableBtn.classList.add("hidden");
    }

    completeBtn.addEventListener("click", () => {
      if (!selectedBanId) return alert("Vui l√≤ng ch·ªçn b√†n!");
      if (!hoaDonTheoBan[selectedBanId]) hoaDonTheoBan[selectedBanId] = [];
      hoaDonTheoBan[selectedBanId].push(...bill.map((item) => ({ ...item })));
      localStorage.setItem("hoaDonTheoBan", JSON.stringify(hoaDonTheoBan));
      bill.length = 0;
      renderBill();
      completeBtn.classList.add("hidden");
      chooseTableBtn.classList.remove("hidden");
      selectedBanId = null;
      renderBan();
      alert("ƒê√£ l∆∞u s·∫£n ph·∫©m v√†o b√†n");
    });

    // --- Xem danh s√°ch b√†n + m√≥n + Thanh to√°n ---
    const viewBanContainerEl = document.getElementById("viewBanContainer");
    const viewTablesBtn = document.getElementById("viewTablesBtn");

    viewTablesBtn.addEventListener("click", () => {
      renderViewBan();
      viewBanContainerEl.classList.remove("hidden");
    });

    function renderViewBan() {
      const viewBanGrid = document.getElementById("viewBanGrid");
      viewBanGrid.innerHTML = "";
      hoaDonTheoBan = JSON.parse(localStorage.getItem("hoaDonTheoBan")) || {};

      if (!banList.length) {
        viewBanGrid.innerHTML =
          '<p class="text-center text-gray-500 col-span-4">Ch∆∞a c√≥ b√†n n√†o</p>';
        return;
      }

      banList.forEach((ban) => {
        const banData = hoaDonTheoBan[ban.ban_id] || [];
        const div = document.createElement("div");
        div.className = "relative border p-3 rounded-lg shadow-sm bg-gray-50";
        div.innerHTML = `<p class="font-semibold mb-2">${ban.ten_ban}</p>`;

        if (!banData.length)
          div.innerHTML += '<p class="text-gray-500">Ch∆∞a c√≥ s·∫£n ph·∫©m</p>';
        else {
          const ul = document.createElement("ul");
          banData.forEach((item) => {
            const li = document.createElement("li");
            li.textContent = `${item.ten_san_pham} ${item.kich_co ? "(" + item.kich_co + ")" : ""} ${item.toppings.length ? "+ " + item.toppings.map((t) => t.ten_topping).join(", ") : ""} x${item.so_luong}`;
            ul.appendChild(li);
          });
          div.appendChild(ul);

          const payBtn = document.createElement("button");
          payBtn.className =
            "absolute top-2 right-2 w-10 h-10 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center justify-center font-semibold";
          payBtn.textContent = "üí∞";

          payBtn.addEventListener("click", () => {
            const modal = document.createElement("div");
            modal.className =
              "fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-40";
            modal.innerHTML = `
              <div class="bg-white rounded-2xl p-6 shadow-lg w-full max-w-2xl mx-auto">
                <div class="flex flex-col md:flex-row gap-6">
                  <div class="flex-1 flex flex-col gap-4">
                    <div class="flex gap-2">
                      <input id="memberPhoneInput" type="text" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i th√†nh vi√™n..." class="flex-1 px-2 py-1.5 text-sm rounded-lg border text-gray-800 focus:outline-none focus:ring-2 focus:ring-yellow-400"/>
                      <button id="searchMemberBtn" class="bg-blue-500 hover:bg-blue-600 text-white py-1.5 px-3 text-sm rounded-lg font-semibold transition">üîç T√¨m ki·∫øm</button>
                    </div>
                    <p id="memberName" class="text-green-600 font-semibold text-sm truncate"></p>
                    <div class="flex gap-2">
                      <input id="promoCodeInput" type="text" placeholder="Nh·∫≠p m√£ khuy·∫øn m√£i..." class="flex-1 px-2 py-1.5 text-sm rounded-lg border text-gray-800 focus:outline-none focus:ring-2 focus:ring-yellow-400"/>
                      <button id="applyBtn" class="bg-yellow-400 hover:bg-yellow-500 text-white py-1.5 px-3 text-sm rounded-lg font-semibold transition">√Åp d·ª•ng</button>
                    </div>
                  </div>
                  <div class="flex-1 flex flex-col gap-3">
                    <h2 class="text-lg font-semibold mb-2 text-left">Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n</h2>
                    <button id="cashBtn" class="bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg font-semibold w-full">üíµ Ti·ªÅn m·∫∑t</button>
                    <button id="bankingBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white py-2 rounded-lg font-semibold w-full">üè¶ Banking</button>
                    <button id="cancelBtn" class="bg-gray-200 hover:bg-gray-300 py-2 rounded-lg font-semibold w-full">H·ªßy</button>
                  </div>
                </div>
              </div>
            `;
            document.body.appendChild(modal);

            // --- Event listener g·∫Øn ngay sau khi modal ƒë∆∞·ª£c t·∫°o ---
            const applyBtn = modal.querySelector("#applyBtn");
            const promoInput = modal.querySelector("#promoCodeInput");

            applyBtn.addEventListener("click", async () => {
              const ma_khuyen_mai = promoInput.value.trim();
              const thanh_vien_id = modal.dataset.memberId;

              if (!ma_khuyen_mai) return alert("Vui l√≤ng nh·∫≠p m√£ khuy·∫øn m√£i!");
              if (!thanh_vien_id) return alert("Vui l√≤ng t√¨m th√†nh vi√™n tr∆∞·ªõc khi √°p d·ª•ng m√£!");

              try {
                const res = await fetch("http://localhost:3000/mucgiamgia/kiemTraMaChoThanhVien", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ ma_khuyen_mai, thanh_vien_id })
                });
                const data = await res.json();

                if (res.ok && data.error === 0) {
                  alert("üéâ √Åp d·ª•ng m√£ khuy·∫øn m√£i th√†nh c√¥ng!");
                  console.log("üéüÔ∏è M√£ khuy·∫øn m√£i h·ª£p l·ªá:", data.data);

                  // L∆∞u th√¥ng tin gi·∫£m gi√° v√†o modal ƒë·ªÉ d√πng khi thanh to√°n
                  modal.dataset.mucGiamGiaId = data.data.muc_giam_gia_id;
                  modal.dataset.phanTramGiam = data.data.phan_tram_giam;

                  // T√≠nh l·∫°i t·ªïng ti·ªÅn d·ª±a tr√™n ph·∫ßn trƒÉm gi·∫£m
                  const monAn = hoaDonTheoBan[ban.ban_id] || [];
                  const tongTien = monAn.reduce(
                    (sum, item) => sum + (Number(item.gia_co_ban) + Number(item.gia_them || 0) + Number(item.tong_topping || 0)) * item.so_luong,
                    0
                  );
                  const tienSauGiam = tongTien * (1 - Number(data.data.phan_tram_giam) / 100);
                  totalEl.textContent = tienSauGiam.toLocaleString() + " ƒë";

                  // L∆∞u t·∫°m v√†o modal ƒë·ªÉ khi thanh to√°n ti·ªÅn s·∫Ω √°p d·ª•ng
                  modal.dataset.tienSauGiam = String(tienSauGiam);
                } else {
                  alert("‚ùå M√£ khuy·∫øn m√£i kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng!");
                }
              } catch (err) {
                console.error(err);
                alert("‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server!");
              }
            });

            modal.querySelector("#searchMemberBtn").addEventListener("click", async () => {
              const sdt = modal.querySelector("#memberPhoneInput").value.trim();
              if (!sdt) return alert("Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i!");
              try {
                const res = await fetch(`http://localhost:3000/thanhvien/timtheosdt/${sdt}`);
                if (!res.ok) throw new Error("Kh√¥ng t√¨m th·∫•y th√†nh vi√™n");
                const member = await res.json();
                console.log("üîç Th√¥ng tin th√†nh vi√™n t√¨m th·∫•y:", member);
                modal.querySelector("#memberName").textContent = `üë§ ${member.ho_ten}`;
                modal.dataset.memberId = member.thanh_vien_id;
              } catch (err) {
                alert("Kh√¥ng t√¨m th·∫•y th√†nh vi√™n!");
                modal.querySelector("#memberName").textContent = "";
                modal.dataset.memberId = null;
                console.error(err);
              }
            });

            // --- THANH TO√ÅN TI·ªÄN M·∫∂T ---
            modal.querySelector("#cashBtn").addEventListener("click", async () => {
              const monAn = hoaDonTheoBan[ban.ban_id] || [];
              if (!monAn.length) return alert("B√†n n√†y ch∆∞a c√≥ m√≥n!");

              const tongTienBan = monAn.reduce(
                (sum, item) =>
                  sum +
                  (Number(item.gia_co_ban) +
                    Number(item.gia_them || 0) +
                    Number(item.tong_topping || 0)) *
                    item.so_luong,
                0
              );

              const phanTramGiam = modal.dataset.phanTramGiam
                ? Number(modal.dataset.phanTramGiam)
                : 0;
              const tienSauGiam = tongTienBan * (1 - phanTramGiam / 100);

              console.log("üí∞ T·ªïng ti·ªÅn tr∆∞·ªõc gi·∫£m:", tongTienBan.toLocaleString() + " ƒë");
              if (phanTramGiam > 0) {
                console.log(
                  `üí∏ √Åp d·ª•ng m√£ gi·∫£m gi√° ${phanTramGiam}% -> T·ªïng ti·ªÅn sau gi·∫£m:`,
                  tienSauGiam.toLocaleString() + " ƒë"
                );
              }

              const chiTiet = [];
              monAn.forEach((item) => {
                const donGia = Number(item.gia_co_ban) + Number(item.gia_them || 0) + Number(item.tong_topping || 0);
                if (item.toppings.length) {
                  item.toppings.forEach((t) => {
                    chiTiet.push({
                      san_pham_id: item.san_pham_id,
                      kich_co_id: item.kich_co_id,
                      topping_id: t.topping_id,
                      so_luong: item.so_luong,
                      don_gia: donGia,
                    });
                  });
                } else {
                  chiTiet.push({
                    san_pham_id: item.san_pham_id,
                    kich_co_id: item.kich_co_id,
                    topping_id: null,
                    so_luong: item.so_luong,
                    don_gia: donGia,
                  });
                }
              });

              const payload = {
                thanh_vien_id: modal.dataset.memberId || null,
                ban_id: ban.ban_id,
                tai_khoan_id: user.tai_khoan_id || 1,
                tong_tien: tongTienBan,
                tien_sau_giam: tienSauGiam,
                muc_giam_gia_id: modal.dataset.mucGiamGiaId || null,
                trang_thai: "ƒê√£ thanh to√°n",
                chi_tiet: chiTiet,
              };

              try {
                const res = await fetch("http://localhost:3000/donhang/them", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(payload),
                });
                const data = await res.json();

                if (res.ok) {
                  alert("ƒê√£ l∆∞u ƒë∆°n h√†ng th√†nh c√¥ng!");

                  if (modal.dataset.mucGiamGiaId && modal.dataset.memberId) {
                    const thanhVien = {
                      thanh_vien_id: modal.dataset.memberId,
                      da_su_dung: 1,
                      ten_thanh_vien: modal.querySelector("#memberName").textContent.replace("üë§ ", "")
                    };

                    await fetch(`http://localhost:3000/mucgiamgia/capnhatthongtin/${modal.dataset.mucGiamGiaId}`, {
                      method: "PUT",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify(thanhVien)
                    });

                    console.log("‚úÖ C·∫≠p nh·∫≠t m√£ gi·∫£m gi√° th√†nh c√¥ng:", thanhVien);
                  }

                  delete hoaDonTheoBan[ban.ban_id];
                  localStorage.setItem("hoaDonTheoBan", JSON.stringify(hoaDonTheoBan));
                  renderViewBan();
                  renderBan();
                } else {
                  alert("L·ªói khi l∆∞u ƒë∆°n h√†ng: " + (data.message || JSON.stringify(data)));
                  console.error(data);
                }
              } catch (err) {
                console.error(err);
                alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server!");
              }

              modal.remove();
            });

            // --- THANH TO√ÅN TR·ª∞C TUY·∫æN (BANKING) ---
// --- THANH TO√ÅN TR·ª∞C TUY·∫æN (BANKING) ---
modal.querySelector("#bankingBtn").addEventListener("click", async () => {
  const monAn = hoaDonTheoBan[ban.ban_id] || [];
  if (!monAn.length) return alert("B√†n n√†y ch∆∞a c√≥ m√≥n!");

  const tongTienBan = monAn.reduce(
    (sum, item) =>
      sum +
      (Number(item.gia_co_ban) +
        Number(item.gia_them || 0) +
        Number(item.tong_topping || 0)) *
        item.so_luong,
    0
  );

  const phanTramGiam = modal.dataset.phanTramGiam
    ? Number(modal.dataset.phanTramGiam)
    : 0;
  const tienSauGiam = tongTienBan * (1 - phanTramGiam / 100);

  console.log("üí∞ T·ªïng ti·ªÅn tr∆∞·ªõc gi·∫£m:", tongTienBan.toLocaleString() + " ƒë");
  if (phanTramGiam > 0) {
    console.log(
      `üí∏ √Åp d·ª•ng m√£ gi·∫£m gi√° ${phanTramGiam}% -> T·ªïng ti·ªÅn sau gi·∫£m:`,
      tienSauGiam.toLocaleString() + " ƒë"
    );
  }

  // Chu·∫©n b·ªã items cho PayOS
  const payosItems = [];
  monAn.forEach((item) => {
    let itemName = item.ten_san_pham;
    if (item.kich_co) itemName += ` (${item.kich_co})`;
    if (item.toppings.length) {
      itemName += ` + ${item.toppings.map((t) => t.ten_topping).join(", ")}`;
    }

    const itemPrice = Number(item.gia_co_ban) + Number(item.gia_them || 0) + Number(item.tong_topping || 0);

    payosItems.push({
      name: itemName,
      quantity: item.so_luong,
      price: itemPrice
    });
  });

  // R√∫t ng·∫Øn t√™n b√†n ƒë·ªÉ description <= 25 k√Ω t·ª±
  const tenBan = banList.find(b => b.ban_id === ban.ban_id).ten_ban;
  const shortDescription = `${tenBan} - Coffee`.substring(0, 25); // T·ªëi ƒëa 25 k√Ω t·ª±

  // Payload cho PayOS
  const payosPayload = {
    amount: Math.round(tienSauGiam),
    description: shortDescription, // ‚úÖ ƒê√£ r√∫t ng·∫Øn
    returnUrl: `${window.location.origin}/view/pos?payment=success&ban_id=${ban.ban_id}`,
    cancelUrl: `${window.location.origin}/view/pos?payment=cancel`,
    items: payosItems
  };

  console.log("üì¶ Payload g·ª≠i ƒë·∫øn PayOS:", JSON.stringify(payosPayload, null, 2));

  // Chu·∫©n b·ªã chi ti·∫øt ƒë∆°n h√†ng
  const chiTiet = [];
  monAn.forEach((item) => {
    const donGia = Number(item.gia_co_ban) + Number(item.gia_them || 0) + Number(item.tong_topping || 0);
    if (item.toppings.length) {
      item.toppings.forEach((t) => {
        chiTiet.push({
          san_pham_id: item.san_pham_id,
          kich_co_id: item.kich_co_id,
          topping_id: t.topping_id,
          so_luong: item.so_luong,
          don_gia: donGia,
        });
      });
    } else {
      chiTiet.push({
        san_pham_id: item.san_pham_id,
        kich_co_id: item.kich_co_id,
        topping_id: null,
        so_luong: item.so_luong,
        don_gia: donGia,
      });
    }
  });

  const orderData = {
    thanh_vien_id: modal.dataset.memberId || null,
    ban_id: ban.ban_id,
    tai_khoan_id: user.tai_khoan_id || 1,
    tong_tien: tongTienBan,
    tien_sau_giam: tienSauGiam,
    muc_giam_gia_id: modal.dataset.mucGiamGiaId || null,
    trang_thai: "Ch·ªù thanh to√°n",
    chi_tiet: chiTiet,
  };

  // L∆∞u v√†o sessionStorage
  sessionStorage.setItem(`pending_order_${ban.ban_id}`, JSON.stringify(orderData));

  try {
  const res = await fetch("http://localhost:3000/order/create-payment-link", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payosPayload),
  });

  const data = await res.json();
  console.log("üì° Response data:", data);

  // ‚úÖ Ki·ªÉm tra ƒë√∫ng structure
  if (data.error === 0 && data.data?.checkoutUrl) {
    console.log("‚úÖ T·∫°o payment link th√†nh c√¥ng:", data.data.checkoutUrl);
    modal.remove();
    window.location.href = data.data.checkoutUrl;
  } else {
    throw new Error(data.message || "Kh√¥ng th·ªÉ t·∫°o li√™n k·∫øt thanh to√°n");
  }
} catch (err) {
  console.error("‚ùå L·ªói:", err);
  alert(`‚ùå Kh√¥ng th·ªÉ t·∫°o li√™n k·∫øt thanh to√°n!\n\nL·ªói: ${err.message}`);
}
});
            modal.querySelector("#cancelBtn").addEventListener("click", () => modal.remove());
          });

          div.appendChild(payBtn);
        }

        viewBanGrid.appendChild(div);
      });
    }

    window.closeViewBanModal = () => {
      viewBanContainerEl.classList.add("hidden");
    };

    // --- T√¨m ki·∫øm & l·ªçc ---
    const searchInput = document.getElementById("search");
    const filterSelect = document.getElementById("filter");
    const allProducts = Array.from(document.querySelectorAll(".product"));

    function filterProducts() {
      const keyword = searchInput.value.toLowerCase().trim();
      const selectedLoai = filterSelect.value;
      allProducts.forEach((p) => {
        const ten = p.dataset.ten.toLowerCase();
        const loai = p.dataset.loai;
        const matchTen = ten.includes(keyword);
        const matchLoai = selectedLoai === "" || loai === selectedLoai;
        p.style.display = matchTen && matchLoai ? "" : "none";
      });
    }

    searchInput.addEventListener("input", filterProducts);
    filterSelect.addEventListener("change", filterProducts);

    // --- X·ª¨ L√ù K·∫æT QU·∫¢ THANH TO√ÅN T·ª™ PAYOS ---
    const urlParams = new URLSearchParams(window.location.search);
    const paymentStatus = urlParams.get('payment');
    const banIdFromUrl = urlParams.get('ban_id');

    if (paymentStatus === 'success' && banIdFromUrl) {
      // Thanh to√°n th√†nh c√¥ng
      (async () => {
        const orderData = JSON.parse(sessionStorage.getItem(`pending_order_${banIdFromUrl}`));
        
        if (orderData) {
          orderData.trang_thai = "ƒê√£ thanh to√°n";
          
          try {
            const res = await fetch("http://localhost:3000/donhang/them", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(orderData),
            });
            
            if (res.ok) {
              console.log("‚úÖ ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!");
              
              if (orderData.muc_giam_gia_id && orderData.thanh_vien_id) {
                await fetch(`http://localhost:3000/mucgiamgia/capnhatthongtin/${orderData.muc_giam_gia_id}`, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    thanh_vien_id: orderData.thanh_vien_id,
                    da_su_dung: 1
                  })
                });
              }
              
              delete hoaDonTheoBan[banIdFromUrl];
              localStorage.setItem("hoaDonTheoBan", JSON.stringify(hoaDonTheoBan));
              sessionStorage.removeItem(`pending_order_${banIdFromUrl}`);
              
              alert("üéâ Thanh to√°n th√†nh c√¥ng!");
              window.location.href = "/view/pos";
            } else {
              alert("‚ùå L·ªói khi l∆∞u ƒë∆°n h√†ng!");
              window.location.href = "/view/pos";
            }
          } catch (err) {
            console.error("‚ùå L·ªói khi l∆∞u ƒë∆°n h√†ng:", err);
            alert("‚ùå Kh√¥ng th·ªÉ l∆∞u ƒë∆°n h√†ng!");
            window.location.href = "/view/pos";
          }
        } else {
          window.location.href = "/view/pos";
        }
      })();
    } else if (paymentStatus === 'cancel') {
      alert("‚ùå Thanh to√°n ƒë√£ b·ªã h·ªßy. ƒê∆°n h√†ng v·∫´n ƒë∆∞·ª£c gi·ªØ nguy√™n.");
      window.location.href = "/view/pos";
    }
  });

  // Log th√¥ng tin user
  const user = JSON.parse(localStorage.getItem("user"));
  if (user) {
    console.log("üì¶ Th√¥ng tin t√†i kho·∫£n ƒëƒÉng nh·∫≠p:", user);
  } else {
    console.log("‚ùå Ch∆∞a c√≥ t√†i kho·∫£n ƒëƒÉng nh·∫≠p trong localStorage");
  }
</script>

  </body>
</html>